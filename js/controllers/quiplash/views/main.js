define(["jquery","underscore","backbone","analytics","models/customer","text!controllers/quiplash/templates/main.html","css!controllers/quiplash/css/main.css"],function(e,t,n,r,i,s){var o=n.View.extend({el:e("#container"),model:i,appName:"Quiplash",appId:"quiplash",appVersion:"1.0",testBlob:undefined,initialize:function(t){var i=this;r.setApplication(this.appName,this.appId,this.appVersion),this.render(this.model.attributes),this.model.on("change",this.update,this),this.update(),e(window).resize(i.onResize),this.model.client.isPlayer()||n.bannerInit()},events:{"click #quiplash-startgame":"startGame","click #quiplash-stopcountdown":"stopCountdown","click #quiplash-sameplayers":"newGameSamePlayers","click #quiplash-newplayers":"newGameNewPlayers","click #quiplash-submit-answer":"submitAnswer","click .quiplash-vote-button":"vote"},render:function(){var e=t.template(s,this.model.toJSON());this.$el.html(e)},adjustColor:function(e,t){var n=!1;e[0]=="#"&&(e=e.slice(1),n=!0);var r=parseInt(e,16),i=Math.min(Math.max(0,(r>>16)*t),255),s=Math.min(Math.max(0,(r>>8&255)*t),255),o=Math.min(Math.max(0,(r&255)*t),255),u=(o|s<<8|i<<16).toString(16);while(u.length<e.length)u="0"+u;return(n?"#":"")+u},update:function(){var t=this;if(!this.model.attributes.roomBlob){this.showScreen("#state-logo");return}var i=this.model.attributes.roomBlob,s=this.model.attributes.customerBlob?this.model.attributes.customerBlob:{},o=s?s.state:"",u=i?i.state:"",a=s!=undefined&&s.playerColor!=undefined?s.playerColor:"#5E9DF0";e("#player").css("background-color",a);var f=this.adjustColor(a,.52);e("#state-lobby").css("background-color",f),e("#state-answer-question-audience").css("background-color",f),e("#state-answer-question").css("background-color",f),e("#state-done-answering").css("background-color",f),e("#state-vote").css("background-color",f),this.currentAnswerQuestionId=-1;if(o=="RoomFull"){n.handleError(new Error("The room is full"));return}if(o=="GameLocked"){n.handleError(new Error("Game is in progress. Please wait for a new game to start."));return}if(u&&u=="Lobby"){if(!this.model.client.isPlayer()){this.showScreen("#state-logo");return}this.hideLobbyButtons();if(!s.isAllowedToStartGame){e("#quiplash-lobby-text").html("Sit back and relax!"),this.showScreen("#state-lobby");return}var l=i.lobbyState;l=="WaitingForMore"?e("#quiplash-lobby-text").html("Waiting for all players to join"):l=="CanStart"?(e("#quiplash-lobby-text").html("Press this button when everybody has joined"),e("#quiplash-startgame").show()):l=="Countdown"?(e("#quiplash-lobby-text").html("Press this button to cancel game start"),e("#quiplash-stopcountdown").show()):l=="PostGame"&&(e("#quiplash-lobby-text").html("What do you want to do?"),e(".quiplash-endbuttons").show()),this.showScreen("#state-lobby"),r.trackScreenView(t.appId+"#state-lobby")}else if(u=="Gameplay_Logo")this.showScreen("#state-logo");else if(u=="Gameplay_Round")e("#round-image").attr("src","images/quiplash/Round"+i.round+".png"),this.showScreen("#state-round");else if(u=="Gameplay_AnswerQuestion")if(o=="Gameplay_AnswerQuestion"){if(!s.question){this.showScreen("#state-done-answering");return}this.activeScreen!=="#state-answer-question"&&(e("#quiplash-answer-input").val(""),e("#quiplash-answer-field").show(),e("#quiplash-submit-alert").hide(),e("#state-answer-question #question-text").html(s.question.prompt.replace(/<BLANK>/gi,"________")));if(s.showError){var c=e("#quiplash-submit-alert");e("#quiplash-submit-alert").html("You entered the same thing as someone else! Try again."),c.addClass("alert-info"),c.removeClass("alert-danger"),c.show()}this.currentAnswerQuestionId=s.question.id,this.showScreen("#state-answer-question"),r.trackScreenView(t.appId+"#state-answer-question")}else e(".state-answer-question-audience-text").html("You’re in the audience! Wait for the time to vote."),this.showScreen("#state-answer-question-audience"),this.model.client.isPlayer()||n.slideBannerOn(this.appId);else if(u=="Gameplay_Vote"){this.model.client.isPlayer()||n.slideBannerOff();if(s.doneVoting){e("#vote-text").html("Wait for the other players!"),e("#quiplash-vote").html(""),this.showScreen("#state-vote");return}i.question?e("#state-vote #question-text").html(i.question.prompt.replace(/<BLANK>/gi,"________")):e("#state-vote #question-text").html("");var h="";s.votesLeft>1?h=" votes left":s.votesLeft===1&&(h=" vote left"),e("#vote-text").html(s.hasOwnProperty("votesLeft")?"You have "+s.votesLeft+h:"Which one do you like more?");var p="";if(i.hasOwnProperty("choices")&&i.hasOwnProperty("order"))for(var d=0;d<i.order.length;d++){var v=i.order[d];if(s.hasOwnProperty("ignore")){var m=!1;for(var g=0;g<s.ignore.length;g++)if(s.ignore[g]==v){m=!0;break}if(m)continue}var y=i.choices[v];if(s.hasOwnProperty("votes")){var b=0;for(var w=0;w<s.votes.length;w++)s.votes[w]==v&&b++;b>0&&(y+=" ("+b+")")}p+="<button type='button' data-vote='"+v.toString()+"' class='pure-input-1 quiplash-vote-button button-large pure-button button-quiplash'>"+y+"</button>"}this.notify(),e("#quiplash-vote").html(p),this.showScreen("#state-vote")}},hideLobbyButtons:function(){e("#quiplash-startgame").hide(),e("#quiplash-stopcountdown").hide(),e(".quiplash-endbuttons").hide()},showScreen:function(t){var n=e(t),r=this;if(this.activeScreen&&n.selector===this.activeScreen.selector)return;r.activeScreen&&(r.activeScreen.fadeOut("fast",function(){}),r.activeScreen.show(),r.activeScreen.addClass("pt-page-off")),n.hide(),n.removeClass("pt-page-off"),n.removeClass("pt-page-moveToLeft"),n.fadeIn("fast",function(){}),r.activeScreen=n,r.onResize()},startGame:function(e){return this.model.sendMessage({startGame:!0}),!1},stopCountdown:function(e){return this.model.sendMessage({cancelStartGame:!0}),!1},chooseCategory:function(t){var n=e(t.target).data("num");return this.model.sendMessage({chosenCategory:n}),!1},submitAnswer:function(t){var n=this.sanitize(e("#quiplash-answer-input").val()).toUpperCase();if(n.length===0){var r=e("#quiplash-submit-alert");return e("#quiplash-submit-alert").html("You can't enter nothing!"),r.removeClass("alert-info"),r.addClass("alert-danger"),r.show(),!1}return this.model.sendMessage({answer:n,questionId:this.currentAnswerQuestionId}),!1},vote:function(t){var n=e(t.target).data("vote");return this.model.client.isPlayer()?this.model.sendMessage({vote:n}):this.model.client.isAudience()&&(this.model.sendSessionMessage("vote","Quiplash Vote",{type:"vote",vote:n}),e("#vote-text").html("Thanks, audience member!"),e("#quiplash-vote").html(""),this.showScreen("#state-vote")),!1},newGameSamePlayers:function(e){return this.model.sendMessage({startGame:!0,decision:"PostGame_Continue"}),!1},newGameNewPlayers:function(e){return this.model.sendMessage({startGame:!0,decision:"PostGame_NewGame"}),!1},sanitize:function(e){return e.replace(/[^A-Z0-9\u00A1\u0020-\u002F\u00BF-\u00FF!?*\$\+\-'_ .,:]/gi,"").replace(/'/g,"’").trim()},onResize:function(){var t=e(window).width(),n=e(window).height()-e("#player").outerHeight(!0);e(".quiplash-page").css("height",n),e(".quiplash-page").attr("height",n),e(".quiplash-page").css("width",t),e(".quiplash-page").attr("width",t)},notify:function(){if(window.navigator&&window.navigator.vibrate&&window.navigator.vibrate([100,100]))return}});return o});